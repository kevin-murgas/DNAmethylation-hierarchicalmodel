---
title: "Significant Genes and Enriched Pathways"
author: "Kevin Murgas"
date: "`r Sys.Date()`"
output: pdf_document
---

The genes included here are significantly conserved based on the conservation probability score derived from the posterior distribution of log sigmaP/sigmaT ratio (which will be high when tumor variability is lower than normal variability):
$$ \text{score}_\text{median} = \text{Median} (\text{log}\frac{\sigma_{P}}{\sigma_T}) $$
We select significantly conserved genes based on the top 95th percentile of adjusted bootstrapped values.

```{r load, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(pander)
library(gt)
library(dplyr)
# set working directory
setwd("/Users/kevinmurgas/Documents/Data+ project/EPIC data")
library(here)

rename <- dplyr::rename
select <- dplyr::select
slice <- dplyr::slice

permed_data <- read_csv(here("data-stan_rg3ps3", "permed_data.csv"))
#enrichedGenes <- read_csv(here("prob1genes.csv"))

```

\section{Reactome Enriched Pathways}
```{r paths, echo=FALSE, message=FALSE, comment=NA}

# select enriched genes from permed data
# filter out lowest quartile of sigmaP genes
enrichedGenes <- permed_data %>%
  filter(sigmaP > quantile(sigmaP, 0.25, na.rm=TRUE)) %>%
  select(UCSC_RefGene_Name, score_median, score_median_v3, n) %>%
  rename(Gene=UCSC_RefGene_Name, bootstrap=score_median_v3) %>%
  #filter(score_median > quantile(score_median, 0.95, na.rm = TRUE)) %>%
  filter(bootstrap > 0.95) %>%
  arrange(-bootstrap,-score_median)

# enrichedGenes <- permed_data %>%
#   #filter(sigmaP > quantile(sigmaP, 0.25, na.rm=TRUE)) %>%
#   select(UCSC_RefGene_Name, score_reg, score_reg_v3, n) %>%
#   rename(Gene=UCSC_RefGene_Name, bootstrap=score_reg_v3) %>%
#   #filter(score_reg > quantile(score_reg, 0.95, na.rm = TRUE)) %>%
#   filter(bootstrap > 0.95) %>%
#   arrange(bootstrap,score_reg)

#write.csv(enrichedGenes %>% select(Gene), here("prob1genes.csv"), col.names=FALSE, row.names = FALSE, quote = FALSE)


# Gene Set Enrichment
tidy_gsea <- function(genes) {
  AnnotationDbi::mapIds(org.Hs.eg.db::org.Hs.eg.db, genes, 'ENTREZID', 'SYMBOL') %>%
    ReactomePA::enrichPathway()
}

cat("Begin reactome GSEA...")
ptm<-proc.time()
enrich_reactome <-enrichedGenes %>%
  pull(Gene) %>% tidy_gsea()
proc.time()-ptm

enrichedPaths <- tibble(Pathway = enrich_reactome$Description, ngenes = enrich_reactome$Count, padj = enrich_reactome$p.adjust) %>% arrange(padj)
geneList <- enrich_reactome$geneID %>% strsplit(split='/') %>%
  lapply(function(x) AnnotationDbi::mapIds(org.Hs.eg.db::org.Hs.eg.db, x, 'SYMBOL', 'ENTREZID')) %>%
  lapply(function(x) paste(x,collapse=";")) %>% unlist
enrichedPaths$Genes = geneList

#write.csv(enrichedPaths, here("ReactomeRPACKAGE.csv"), col.names=FALSE, row.names = FALSE, quote = TRUE)

ngene <- dim(enrichedGenes)[1]
npath <- length(enrich_reactome$Description)

cat(paste0("Total number of genes: ", ngene, "     Number of enrichment pathways: ", npath))

cat("score_median top enriched paths:  \n")
enrichedPaths %>% pander()

knit_exit()

```

<!-- \newpage -->
<!-- \section{Top Conserved Genes} -->
<!-- ```{r genes, echo=FALSE, comment=NA} -->
<!-- cat(paste0("score_median top enriched genes:  \n Total number of genes: ", ngene)) -->
<!-- #enrichedGenes %>% arrange(-bootstrap) %>% rename(nsites=n) %>% pander() -->

<!-- ``` -->

\newpage
\section{GSVA-type analysis}
```{r load_geneset, include=FALSE}
# load in the C5 gene sets from MSigDB
library(GSA)
gmtfile <- file.path("/Users/kevinmurgas/Documents/Data+ project/EPIC data","c2.cp.v7.1.symbols.gmt")
genesets <- GSA.read.gmt(gmtfile)
nsets <- length(genesets[[1]])

# make a data.frame for gene sets and scores
nsets <- length(genesets[[1]])
GSEA_df <- data.frame(GeneSet=genesets[[2]][1:nsets], score=numeric(nsets),
                      num_gene = unlist(lapply(genesets[[1]][1:nsets],length)),
                      num_gene_cut = numeric(nsets))

```

\subsection{Evidence: conservation score rank}
```{r GSVA_rank, echo=FALSE, comment=NA, fig.width=8}
# Procedure:
# 1. Order and rank all genes by evidence (currently using log-P/T-ratio integral > 0)
# 2. For each gene set:
#     Create two CDFs/running sums:
#     1. In-set genes: increment by the evidence magnitude or RANK
#     2. Out-of-set genes: increment by 1
#     add 0 to other sum if gene in/not in
#     Normalize by max at the end to get CDFs
#     Take modified K-S statistic, by measuring the difference in the max and min differences of the two CDFs
# 3. Each gene set now has a value to rank enrichment
#  KS statistic
# 4. For significance (FDR), need to compare to KS statistic
# if in set: X = sqrt((N-G)/G) ... with G = # genes in set, N = # genes total
# if not in set: XN=âˆ’sqrt(G/(N-G))

# have to order all genes first by rank of conservation (conserved genes come first)
genenames = permed_data$UCSC_RefGene_Name
ngene = length(genenames)

# reorder by evidence rank
genenames = genenames[order(-permed_data$score_median)] # use ranked conservation score as evidence
evidence = seq(ngene,1,-1)

# plot evidence ranked: permed_data$score_median
ranks <- permed_data$score_median
names(ranks) <- permed_data$UCSC_RefGene_Name
barplot(sort(ranks, decreasing = T), main = "Ranked conservation scores")

cat("Begin calculating random-walk statistics...")
ptm <- proc.time()
for (iset in 1:nsets) {
  # take only genes that we have in full gene list
  set <- unlist(genesets[[1]][iset]) %>% intersect(genenames)
  GSEA_df$num_gene_cut[iset] = length(set)
  
  # skip if num_gene <10 or >500
  if (length(set)<10 | length(set)>500) {next}
  
  # compute running sum (as PDF first)
  # create the random walk, with correct scaling for in/out genes
  inmask = genenames %in% set
  runsum = evidence/sum(evidence[inmask]) * inmask - 1/(ngene-length(set)) * !inmask
  
  # convert to CDF, compute K-S-like statistic
  v <- cumsum(runsum)
  score <- max(c(0,v)) + min(c(0,v))
  GSEA_df$score[iset] <- score
}
cat(proc.time()-ptm)
cat(sprintf("Processed %i genes, %i pathways/genesets. Begin bootstrapping...",ngene,nsets))


# calculate bootstraps
setlengths <- unique(GSEA_df$num_gene_cut)
setlengths <- sort(setlengths[which(!(setlengths < 10 | setlengths > 500))])
# run thru each set length
# store 1000 bootstrapped scores using random gene sets

shuffle_genesets <- function(n_geneset, n_rep, data) {
  bootstrap = numeric(n_rep)
  for (ishuf in 1:n_rep) {
    # for random shuffles just make a random logical mask
    inds = sample(1:ngene, n_geneset, replace = F)
    inmask = logical(ngene)
    inmask[inds] = TRUE
    runsum = evidence/sum(evidence[inmask]) * inmask - 1/(ngene - length(set)) * !inmask
    
    # convert to CDF, compute K-S-like statistic
    v <- cumsum(runsum)
    score <- max(c(0, v)) + min(c(0, v))
    bootstrap[ishuf] <- score
  }
  bootstrap
}

names(setlengths) <- setlengths
cat(sprintf("Shuffling %i set-lengths: 1000x random shuffles (w/o replacement)",length(setlengths)))
ptm<-proc.time()
res <- lapply(setlengths, shuffle_genesets, n_rep = 1000, data = evidence)
proc.time()-ptm

# map enrichment scores to get percentiles on bootstrap null distribution using upper tail probability
pvals <- map2_dbl(GSEA_df$score, GSEA_df$num_gene_cut, ~ mean(res[[as.character(.y)]] > .x))

# Benjamini-Hochberg step-up correction procedure
# this matches r p.adjust("BH")
ptemp <- pvals[!is.na(pvals)]
m <- length(ptemp)
BHp <- sort(ptemp,decreasing=T,na.last=TRUE)*m/seq(m,1)
BHp[order(ptemp,decreasing=T)] <- cummin(BHp)
q <- pvals*NA
q[!is.na(pvals)] <- BHp

GSEA_df$pval <- pvals
GSEA_df$FDR <- q

nsig <- sum(GSEA_df$FDR<0.05, na.rm=TRUE)
ntot <- sum(!is.na(GSEA_df$FDR))
cat(sprintf("%i significant pathways out of %i tested (%i excluded by size <10 | >500)", nsig, ntot, nsets-ntot))
# make table of top scores
GSEA_df %>% arrange(FDR) %>%
  filter(FDR<0.05) %>%
  select(score,pval,FDR,num_gene_cut,GeneSet) %>%
  rename(Ngene=num_gene_cut) %>%
  #mutate(GeneSet = gsub('(.{1,90})(\\s|$)', '\\1\n', GeneSet)) %>%
  gt() %>% cols_align(align="left") %>% fmt_number(vars(score,pval,FDR),decimals=3)

# save as .csv
enrichedGenes <- permed_data %>%
  filter(sigmaP > quantile(sigmaP, 0.25, na.rm=TRUE)) %>%
  select(UCSC_RefGene_Name, score_median, score_median_v3, n) %>%
  rename(Gene=UCSC_RefGene_Name, bootstrap=score_median_v3) %>%
  filter(bootstrap > 0.95) %>%
  arrange(-bootstrap,-score_median)

write.csv(enrichedGenes, here("significantgenes_filtered.csv"), col.names=FALSE, row.names = FALSE, quote = FALSE)
write.csv(GSEA_df %>% arrange(FDR) %>%
  filter(FDR<0.05) %>%
  select(score,pval,FDR,num_gene_cut,GeneSet) %>%
  rename(Ngene=num_gene_cut), here("GSVApathways_significantFDR.csv"), col.names=FALSE, row.names = FALSE, quote = FALSE)
```
